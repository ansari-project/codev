#!/usr/bin/env bash
# Pre-commit hook for Codev
# Runs the test suite before allowing commits

set -e

# Change to project root
cd "$(git rev-parse --show-toplevel)"

echo "Running Codev test suite..."

# Run the bats test suite
if ! ./scripts/run-tests.sh; then
    echo "❌ Bats tests failed - commit aborted"
    echo ""
    echo "To skip this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

# Run agent-farm TypeScript tests if the directory exists
if [[ -d "agent-farm" && -f "agent-farm/package.json" ]]; then
    echo ""
    echo "Running agent-farm TypeScript tests..."

    # Check if node_modules exists, install if needed
    if [[ ! -d "agent-farm/node_modules" ]]; then
        echo "Installing agent-farm dependencies..."
        (cd agent-farm && npm install --silent)
    fi

    # Run TypeScript build and tests
    if ! (cd agent-farm && npm run build --silent && npm test -- --run); then
        echo "❌ agent-farm tests failed - commit aborted"
        echo ""
        echo "To skip this check (not recommended):"
        echo "  git commit --no-verify"
        exit 1
    fi
fi

echo ""
echo "✅ All tests passed"
exit 0
